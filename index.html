<!DOCTYPE html>

<html>
<!-- Histyory -->
<!-- GPL by M.Karaskiewicz 2019 - V1.4 with coordinates clear size - delta, pad, leroy passw added -->
<!-- GPL by M.Karaskiewicz 2023 - V1.6 no drowing on manual coorinates -->
<!-- GPL by M.Karaskiewicz 2023 - V1.6.2 adaptive -->
<!-- GPL by M.Karaskiewicz 2023 - V1.6.4 summer time checkbox - 01.03.2025-->
<!-- GPL by M.Karaskiewicz 2023 - V1.6.5 better hint Text in HTML - 02.03.2025-->


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="https://d3js.org/d3-scale.v2.min.js"></script>
<script src="suntime.lib.js"></script>

<script src="locations.js"></script>

<meta charset="utf-8">
<style>
    /* set the CSS */
    body {
        font: 12px Arial;
    }

    path {
        stroke: steelblue;
        stroke-width: 2;
        fill: none;
    }

    .axis path,
    .axis line {
        fill: none;
        stroke: grey;
        stroke-width: 1;
        shape-rendering: crispEdges;
    }

    div.tooltip {
        position: absolute;
        text-align: center;
        width: 60px;
        height: 28px;
        padding: 2px;
        font: 12px sans-serif;
        background: lightsteelblue;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
    }

    .slider-wrapper input {
        width: 350px;
        height: 20px;
        margin: 0;

    }

    .sliderX-wrapper input {
        width: 350px;
        height: 20px;
        margin: 0;

    }

    .suntimeDisplay {
        font: 21px sans-serif;
    }

    .suntimeSunset {
        font: 21px sans-serif;
        color: red;
        font-weight: bold;

    }

    .suntimeSunrise {
        font: 21px sans-serif;
        color: blue;
        font-weight: bold;
    }

    .suntimeDayLength {
        font: 21px sans-serif;
        color: green;
        font-weight: bold;
    }

    .suntimeHeading {
        font: 17px TimesNewRoman;
        color: rgb(102, 0, 128);
        font-weight: bold;
    }

    .suntimeZooms {
        font: 17px TimesNewRoman;
        color: rgb(102, 0, 128);
        font-weight: bold;
    }

    body {
        background-color: lightblue;
    }
</style>

<body>
    <p id="idSuntimeHeading" class="suntimeHeading">.</p>
    <p>Date: <input id="inputDate" type="date">
        (Location selection:<select id="myselect">
            <option value="0">.</option>
        </select>
        ) or ( manually - Latitude:<input id="inputLatitude" value=0 type="number" min="-90.0000" max="90.0000">
        Longitude:<input id="inputLongitude" value=0 type="number" min="-180.0000" max="180.0000">
        TimeZone:<input id="inputTimezone" value=0 type="number" min="-12.00" max="12.00">)
        <button onclick="drawSunData(this)">Apply</button>
        <button onclick="clearCoord()">Clear manual entries</button>
        <input id="inputDeltaMode" type="checkbox">Day length increment mode</br>
        <input id="inputHideDST" type="checkbox">Hide DST</br>
    </p>
    <p class="sunttimeZooms">

        <span> Days ahead: </span><span id="sliderValue"></span>
        <span class="slider-wrapper">
            <input id="dSpan" type="range" min="1" max="1370" step="1" value=150 onchange="drawSunData(this)">
        </span>
        <span> Vertical zoom: </span><span id="sliderValueX"></span>
        <span class="sliderX-wrapper">
            <input id="dSpanX" type="range" min="100" max="5000" step="1" value=500 onchange="drawSunData(this)">
        </span>
        <label for="other">Back.color</label>
        <input id="colorP" type="color" name="favcolor" value="#ff0000" onchange="setBodyCol()">
    </p>
    <span id="coord" class="suntimeDisplay">Coordinates: </span>
    <span id="timeZone" class="suntimeDisplay">Time Zone: </br></span>
    <span class="suntimeDisplay">Sunrise: </span><span id="sunrise" class="suntimeSunrise"> </span>
    <span class="suntimeDisplay">Sunset: </span><span id="sunset" class="suntimeSunset"> </span>
    <span class="suntimeDisplay">Day length: </span><span id="dayLen" class="suntimeDayLength"> </span>
    <span id="polarDay" class="suntimeDayLength"> </span>



    <script>
        const gcHeadSuntimes = "Sunrise/set times V1.6.5";
        const gcHeadSuntimesDelta = "Sunrise/set times V1.6.5 - day increment mode";
    </script>


    <script>
        let gcScreenWidth = document.documentElement.clientWidth; //screen.width;
        var inactivityTime = function () {

            var time;
            window.onload = resetTimer;
            // DOM Events
            document.onmousemove = resetTimer;
            document.onkeypress = resetTimer;

            function logout() {
                alert("You are now logged out")
                //location.href = 'logout.html'
            }

            function resetTimer() {
                clearTimeout(time);
                time = setTimeout(logout, 13000)
                // 1000 milliseconds = 1 second
            }

        };



        var foundMax = 0;
        var maxSign = 1.0000000000001;
        var multip = 100;
        var deltaMode = 0;
        var hideDSTMode = 0; // hide DST shift
        var slider = document.getElementById("dSpan");
        var output = document.getElementById("sliderValue");
        output.innerHTML = slider.value;

        slider.oninput = function () {
            output.innerHTML = this.value;
        }
        var aSunDataSR = [];
        var aSunDataSS = [];
        var aSunDataDL = [];  // DayLength
        var aSunDataDLDelta = [];  //with delta

        // define the x scale (horizontal)


        window.onload = setDateforDisplay();
        var mindate = new Date(document.getElementById("inputDate").value),
            maxdate = 0;

        let PrefixSR = " ";
        let PrefixSS = " ";
        let PrefixDD = " ";

        (function init() {
            debugger;
            document.getElementById("idSuntimeHeading").innerHTML = gcHeadSuntimes;
            drawSunData(this);
        })();



        this.select = document.getElementById("myselect");
        var options = this.locationsJSON

        // Optional: Clear all existing options first:
        this.select.innerHTML = "";
        // Populate list with options:
        for (var i = 0; i < options.length; i++) {
            var opt = options[i].city;
            this.select.innerHTML += "<option value=\"" + opt + "\">" + opt + "</option>";
        };

        // ***************** FUNCTIONS ***********************



        function clearCoord() {
            document.getElementById("inputLongitude").value = 0;
            document.getElementById("inputLatitude").value = 0;
            document.getElementById("inputTimezone").value = 0;
        }

        function setDateforDisplay() {
            // inactivityTime();
            const today = new Date()
            const tomorrow = new Date(today)
            tomorrow.setDate(tomorrow.getDate() + 1)

            var mikDate = new Date();
            var mikMM = 0;

            mikDate = tomorrow;
            if (
                mikDate.getMonth() < 9
            ) {
                mikMM = mikDate.getMonth() + 1;
                mikMM = "0" + mikMM;
            } else {
                mikMM = mikDate.getMonth() + 1;
            }
            var mikDD = 0;
            if (
                mikDate.getDate() < 10
            ) {
                mikDD = "0" + mikDate.getDate();
            } else {
                //               mikDD = mikDate.getDate() + 1;
                mikDD = mikDate.getDate(); // + 1;
            }


            let formatted_date = mikDate.getFullYear() + "-" + mikMM + "-" + mikDD;
            document.getElementById('inputDate').value = formatted_date;
        };
        function setXHeight() {
            heightX = document.getElementById("dSpanX").value;
        };
        function setBodyCol() {
            document.body.style.backgroundColor = document.getElementById("colorP").value;
        };

        function switchDateFactory(year, month) {
            var SDate = new Date(year, month, 31);
            var err;
            var aDays = [20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31]
                ;
            return {

                getMarchSunnday: function () {
                    try {
                        aDays.reverse().forEach(function (item, index) {
                            var SDateLoc = new Date(year, 2, item);
                            if (SDateLoc.getDay() == "0") {
                                //   debugger;
                                throw SDateLoc;
                            }
                        }
                        )
                    }
                    catch (err) {
                        return err;
                    }
                },
                getOktoberSunnday: function () {
                    try {
                        aDays.reverse().forEach(function (item, index) {
                            var SDateLoc = new Date(year, 9, item);
                            if (SDateLoc.getDay() == "0") {
                                //   debugger;
                                throw SDateLoc;
                            }
                        }
                        )
                    }
                    catch (err) {
                        return err;
                    }
                }


            }
        };

        function getTimeZoneShift(year, month, day) {

            // 01032025 
            if (hideDSTMode == 1) { return 0; }

            //
            var oMarchSwitchDate = new switchDateFactory(year, 2);
            var sDay3 = oMarchSwitchDate.getMarchSunnday().getDate();
            var sMonth3 = oMarchSwitchDate.getMarchSunnday().getMonth();

            var sDay10 = oMarchSwitchDate.getOktoberSunnday().getDate();
            var sMonth10 = oMarchSwitchDate.getOktoberSunnday().getMonth();

            if (month >= sMonth3 & month <= sMonth10)
                switch (month) {
                    case sMonth3:
                        if (day >= sDay3) {
                            return 1;
                        }
                        break;
                    case 3:
                    case 4:
                    case 5:
                    case 6:
                    case 7:
                    case 8:
                        // code block
                        return 1;
                        break;
                    case sMonth10:
                        if (day <= sDay10) {
                            return 1;
                        }
                        break;
                    default:
                        return 0;
                }
            return 0;


        };

        function drawSunData(context) {
            //01.03.2525 
            if (document.getElementById("inputHideDST").checked == true) {
                hideDSTMode = 1;
            }
            else { hideDSTMode = 0; }
            //
            let oDate0 = new Date(document.getElementById("inputDate").value);
            let oYear = oDate0.getFullYear();
            let oMonth = oDate0.getMonth();
            oMonth = oMonth + 1;
            let oDay = oDate0.getDate();



            this.locationsJSON = locations;

            var selectedOption = 0;
            if (this.select != null) {
                selectedOption = this.select.selectedIndex;
            }

            let lvLongitude = parseFloat(document.getElementById("inputLongitude").value);
            let lvLatitude = parseFloat(document.getElementById("inputLatitude").value);
            let lvTimeZone = parseFloat(document.getElementById("inputTimezone").value); // + getTimeZoneShift(oYear, oMonth - 1, oDay);
            let bySelection = true;


            let oLocation1 = null;
            if ((Math.abs(lvLongitude) + Math.abs(lvLatitude) + Math.abs(lvTimeZone)) != 0) {
                //       lvTimeZone = lvTimeZone +  getTimeZoneShift(oYear, oMonth - 1, oDay);
                lvTimeZone = lvTimeZone + getTimeZoneShift(oYear, oMonth - 1, oDay); //2905
                oLocation1 = new Location("Coord", oYear, oMonth, oDay,
                    lvLatitude, lvLongitude, 0, 0, lvTimeZone, 0);
                bySelection = false;
            }
            else {

                var locationIndex = selectedOption;
                lvTimeZone = this.locationsJSON[locationIndex].timeZone + getTimeZoneShift(oYear, oMonth - 1, oDay); //2905
                // oLocation1 = new Location(this.locationsJSON[locationIndex].city, oYear, oMonth, oDay, this.locationsJSON[locationIndex].latitude,
                //     this.locationsJSON[locationIndex].longitude, 0, 0, this.locationsJSON[locationIndex].timeZone, 0);
                oLocation1 = new Location(this.locationsJSON[locationIndex].city, oYear, oMonth, oDay, this.locationsJSON[locationIndex].latitude,
                    this.locationsJSON[locationIndex].longitude, 0, 0, lvTimeZone, 0);
                lvLongitude = this.locationsJSON[selectedOption].longitude;
                lvLatitude = this.locationsJSON[selectedOption].latitude;
                // debugger;
                lvTimeZone = this.locationsJSON[selectedOption].timeZone; // + getTimeZoneShift(oYear, oMonth - 1, oDay);
            }

            let sunRise = oLocation1.get_sunRise();
            let sunSet = oLocation1.get_sunSet();
            let dayLen = oLocation1.getDayLen();
            let dayLenRaw = oLocation1.getDayLenRaw();
            let dayLenDecimal = dayLen[0] + "." + dayLen[1];
            let polarDay = oLocation1.getPolarDay();

            document.getElementById("coord").innerHTML = "Coordinates:" + lvLatitude + ", " + lvLongitude + ",";
            document.getElementById("timeZone").innerHTML = "Timezone:" + lvTimeZone + ", ";
            // document.getElementById("sunrise").innerHTML = PrefixSR + sunRise[0] + ":" + sunRise[1];
            // document.getElementById("sunset").innerHTML = PrefixSS + sunSet[0] + ":" + sunSet[1];
            // document.getElementById("dayLen").innerHTML = PrefixDD + dayLen[0] + ":" + dayLen[1];
            document.getElementById("sunrise").innerHTML = PrefixSR + sunRise;
            document.getElementById("sunset").innerHTML = PrefixSS + sunSet;
            document.getElementById("dayLen").innerHTML = PrefixDD + dayLen[0] + ":" + dayLen[1];

            if (polarDay == 1) {
                document.getElementById("polarDay").innerHTML = "Polar Day" + " </br>";
            }
            else if (polarDay == -1) { document.getElementById("polarDay").innerHTML = "Polar Night" + " </br>" }
            else { document.getElementById("polarDay").innerHTML = " " + " </br>" };

            let daysSpan = document.getElementById("dSpan").value;

            var selectedOption = 0;
            if (this.select != null) {
                selectedOption = this.select.selectedIndex;
            }
            // drawDataSet(oDate0, daysSpan, this, selectedOption);


            //            drawDataSet(oDate0, daysSpan, this, selectedOption, lvLongitude, lvLatitude, lvTimeZone, bySelection);
            // 01032025 {
            if (document.getElementById("inputHideDST").checked == true) {
                hideDSTMode = 1;
            }
            else { hideDSTMode = 0; }
            //}

            if (document.getElementById("inputDeltaMode").checked == true) {

                deltaMode = 1;
                document.getElementById("idSuntimeHeading").innerHTML = gcHeadSuntimesDelta;

            } else { deltaMode = 0; }
           

            document.getElementById("idSuntimeHeading").innerHTML = gcHeadSuntimes;
            if (bySelection == true) {
                document.getElementById('inputDeltaMode').disabled = false;
                if (deltaMode == 0) {
                    //debugger;

                    drawDataSet(oDate0, daysSpan, this, selectedOption, lvLongitude, lvLatitude, lvTimeZone, bySelection);

                }
                else {
                    document.getElementById("idSuntimeHeading").innerHTML = gcHeadSuntimesDelta;
                    drawDataSetWDelta(oDate0, daysSpan, this, selectedOption, lvLongitude, lvLatitude, lvTimeZone, bySelection);
                }
            }
            else {  // manual mode **********

              
                deltaMode = 0;
                document.getElementById("inputDeltaMode").checked = false;
             
                document.getElementById('inputDeltaMode').disabled = true;

                drawDataSetM(oDate0, daysSpan, this, selectedOption, lvLongitude, lvLatitude, lvTimeZone, bySelection);


            }


        };



        function drawDataSet(oDate1, daysSpan, context, locationIndex, iPlongitude, iPlatitude, iPtimeZone, bySelection) {
            var i;
            var sunData = { x: 0, y: 0, sEvent: 0, date: "", polarDay: 0 };
            let oYear = oDate1.getFullYear();
            let oMonth = oDate1.getMonth();
            oMonth = oMonth + 1;
            let oDay = oDate1.getDate();
            let oDate2 = oDate1;

            for (i = 0; i < daysSpan; i++) {

                oDate2.setDate(oDate1.getDate() + 1);

                oYear = oDate2.getFullYear();
                oMonth = oDate2.getMonth();
                oMonth = oMonth + 1;
                oDay = oDate2.getDate();

                if (!bySelection) {
                    //debugger;
                    iPtimeZone = iPtimeZone + getTimeZoneShift(oYear, oMonth - 1, oDay);
                    oLocation1 = new Location("coord", oYear, oMonth, oDay, iPlatitude, iPlongitude, 0, 0, iPtimeZone, 0);
                }
                else {
                    //debugger;
                    var iTimeZone = context.locationsJSON[locationIndex].timeZone + getTimeZoneShift(oYear, oMonth - 1, oDay);
                    oLocation1 = new Location(context.locationsJSON[locationIndex].city, oYear, oMonth, oDay, context.locationsJSON[locationIndex].latitude,
                        context.locationsJSON[locationIndex].longitude, 0, 0, iTimeZone, 0);
                }
                sunRiseRaw = oLocation1.get_sunRise_raw();
                sunSetRaw = oLocation1.get_sunSet_raw();
                sunRise = oLocation1.get_sunRise();
                sunSet = oLocation1.get_sunSet();
                dayLen = oLocation1.getDayLen();
                dayLenRaw = oLocation1.getDayLenRaw();
                polarDay = oLocation1.getPolarDay();


                sunData.x = i * 10;
                sunData.y = sunRiseRaw;
                sunData.sEvent = sunRise;
                sunData.date = oDay.toString() + "-" + oMonth.toString() + "-" + oYear.toString();
                aSunDataSR.push([sunData.x, sunData.y, sunData.sEvent, sunData.date]);

                sunData.x = i * 10;
                sunData.y = sunSetRaw;
                sunData.sEvent = sunSet;
                aSunDataSS.push([sunData.x, sunData.y, sunData.sEvent, sunData.date]);

                sunData.x = i * 10;
                sunData.y = dayLen[0] + dayLen[1] / 60;
                sunData.sEvent = dayLen[0].toString() + ":" + dayLen[1].toString();
                sunData.polarDay = polarDay;
                aSunDataDL.push([sunData.x, sunData.y, sunData.sEvent, sunData.date, sunData.polarDay]);
                // last
                maxdate = oDate2;
            }

            // D3
            d3.select("svg").remove();

            var margin = { top: 30, right: 15, bottom: 30, left: 20 },

                //width = 2000 - margin.left - margin.right,
                width = gcScreenWidth - margin.left - margin.right,
                //heightX = 400;
                heightX = document.getElementById("dSpanX").value;
            height = heightX - margin.top - margin.bottom,
                padding = 0;

            // Set the ranges
            var x = d3.time.scale().range([0, width]);
            var y = d3.scale.linear().range([height, 0]);
            var mindateNew = new Date(document.getElementById("inputDate").value);

            var xScale = d3.time.scale()
                .domain([mindateNew, maxdate])
                .range([padding, width - padding * 2]);   // map these the the chart width = total width minus padding at both sides

            //  Define the axes
            var xAxis = d3.svg.axis().scale(xScale)
                .orient("bottom").ticks(15);

            var yAxis = d3.svg.axis().scale(y)
                .orient("left").ticks(5);

            // Define the line
            var valueline = d3.svg.line()
                .x(function (d) { return x(d.x); })
                .y(function (d) { return y(d.y); });

            // Define the div for the tooltip
            var div = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            // Adds the svg canvas
            var svg = d3.select("body")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            // Get the data
            data = [];
            var data = aSunDataSR;
            aSunDataSR = [];

            data.forEach(function (d) {
                d.x = d[0];
                d.y = d[1];
                d.sR = d[2];
                d.date = d[3];
            });
            data1 = [];
            var data1 = aSunDataSS;
            aSunDataSS = [];

            data1.forEach(function (d) {
                d.x = d[0];
                d.y = d[1];
                d.sS = d[2];
                d.date = d[3];
            });

            dataDL = [];
            var dataDL = aSunDataDL;
            aSunDataDL = [];

            dataDL.forEach(function (d) {
                d.x = d[0];
                d.y = d[1];
                d.dL = d[2];
                d.date = d[3];
                d.polarDay = d[4];

            });

            // Scale the range of the data - SunSet
            x.domain(d3.extent(data1, function (d) { return (d.x); }));
            y.domain([0, 24]);

            // Add the valueline path.
            svg.append("path")
                .attr("class", "line")
                .attr("d", valueline(data));

            // Add the scatterplot
            svg.selectAll("dot")
                .data(data)
                .enter().append("circle")
                .attr("r", 4).attr("fill", "blue")
                .attr("cx", function (d) { return x(d.x); })
                .attr("cy", function (d) { return y(d.y); })
                .on("mouseover", function (d) {
                    div.transition()
                        .duration(200)
                        .style("opacity", .9);
                    div.html("Sun rise " + d.sR + "<br/>" + d.date)
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                    div.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Add the scatterplot  - SS
            // Add the valueline path.
            svg.append("path")
                .attr("class", "line")
                .attr("d", valueline(data1));

            svg.selectAll("dot")
                .data(data1)
                .enter().append("circle")
                .attr("r", 4).attr("fill", "red")
                .attr("cx", function (d) { return x(d.x); })
                .attr("cy", function (d) { return y(d.y); })
                .on("mouseover", function (d) {
                    div.transition()
                        .duration(200)
                        .style("opacity", .9);
                    div.html("Sun set " + d.sS + "<br/>" + d.date)
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                    div.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Add the scatterplot  - DL
            // Add the valueline path.
            svg.append("path")
                .attr("class", "line")
                .attr("d", valueline(dataDL));

            svg.selectAll("dot")
                .data(dataDL)
                .enter().append("circle")
                .attr("r", 4).
                //                attr("fill", "yellow")
                attr("fill", function (d) {
                    if (d.y > 11.98 && d.y < 12.05) {
                        return "red";
                    } else {
                        return "orange";
                    }
                    return "yellow";
                })
                .attr("cx", function (d) { return x(d.x); })
                .attr("cy", function (d) {
                    if (d.polarDay == 0) { return y(d.y); }
                    else if (d.polarDay == 1) { return y(24); }
                    else if (d.polarDay == -1) { return y(0); }
                }
                )
                .on("mouseover", function (d) {
                    if (d.polarDay == 0) {
                        div.transition()
                            .duration(200)
                            .style("opacity", .9);
                        div.html("Day length " + d.dL + "<br/>" + d.date)
                            .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");;
                    }
                    else if (d.polarDay == 1) {
                        div.transition()
                            .duration(200)
                            .style("opacity", .9);
                        div.html("Polar day " + "<br/>" + d.date)
                            .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");;
                    }
                    else if (d.polarDay == -1) {
                        div.transition()
                            .duration(200)
                            .style("opacity", .9);
                        div.html("Polar night " + "<br/>" + d.date)
                            .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");;
                    }
                })
                .on("mouseout", function (d) {
                    div.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Add the X Axis
            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis);

            // Add the Y Axis
            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis);
        };

        function drawDataSetM(oDate1, daysSpan, context, locationIndex, iPlongitude, iPlatitude, iPtimeZone0, bySelection) {
            var i;
            var sunData = { x: 0, y: 0, sEvent: 0, date: "", polarDay: 0 };
            let oYear = oDate1.getFullYear();
            let oMonth = oDate1.getMonth();
            oMonth = oMonth + 1;
            let oDay = oDate1.getDate();
            let oDate2 = oDate1;


            for (i = 0; i < daysSpan; i++) {

                if (1 == 1) {
                    oDate2.setDate(oDate1.getDate() + 1);

                    oYear = oDate2.getFullYear();
                    oMonth = oDate2.getMonth();
                    oMonth = oMonth + 1;
                    oDay = oDate2.getDate();


                    iPtimeZone = iPtimeZone0 + getTimeZoneShift(oYear, oMonth - 1, oDay);


                };

                oLocation2 = new Location("coord", oYear, oMonth, oDay, iPlatitude, iPlongitude, 0, 0, iPtimeZone, 0);

                sunRiseRaw = oLocation2.get_sunRise_raw();
                sunSetRaw = oLocation2.get_sunSet_raw();
                sunRise = oLocation2.get_sunRise();
                sunSet = oLocation2.get_sunSet();
                dayLen = oLocation2.getDayLen();
                dayLenRaw = oLocation2.getDayLenRaw();
                polarDay = oLocation2.getPolarDay();


                sunData.x = i * 10;
                sunData.y = sunRiseRaw;
                sunData.sEvent = sunRise;
                sunData.date = oDay.toString() + "-" + oMonth.toString() + "-" + oYear.toString();
                aSunDataSR.push([sunData.x, sunData.y, sunData.sEvent, sunData.date]);

                sunData.x = i * 10;
                sunData.y = sunSetRaw;
                sunData.sEvent = sunSet;
                aSunDataSS.push([sunData.x, sunData.y, sunData.sEvent, sunData.date]);

                sunData.x = i * 10;
                sunData.y = dayLen[0] + dayLen[1] / 60;
                sunData.sEvent = dayLen[0].toString() + ":" + dayLen[1].toString();
                sunData.polarDay = polarDay;
                aSunDataDL.push([sunData.x, sunData.y, sunData.sEvent, sunData.date, sunData.polarDay]);
                // last
                maxdate = oDate2;
            }

            // D3
            d3.select("svg").remove();

            var margin = { top: 30, right: 15, bottom: 30, left: 20 },
                // width = 1500 - margin.left - margin.right,
                width = gcScreenWidth - margin.left - margin.right,
                //heightX = 400;
                heightX = document.getElementById("dSpanX").value;
            height = heightX - margin.top - margin.bottom,
                padding = 0;

            // Set the ranges
            var x = d3.time.scale().range([0, width]);
            var y = d3.scale.linear().range([height, 0]);
            var mindateNew = new Date(document.getElementById("inputDate").value);

            var xScale = d3.time.scale()
                .domain([mindateNew, maxdate])
                .range([padding, width - padding * 2]);   // map these the the chart width = total width minus padding at both sides

            //  Define the axes
            var xAxis = d3.svg.axis().scale(xScale)
                .orient("bottom").ticks(15);

            var yAxis = d3.svg.axis().scale(y)
                .orient("left").ticks(5);

            // Define the line
            var valueline = d3.svg.line()
                .x(function (d) { return x(d.x); })
                .y(function (d) { return y(d.y); });

            // Define the div for the tooltip
            var div = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            // Adds the svg canvas
            var svg = d3.select("body")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            // Get the data
            data = [];
            var data = aSunDataSR;
            aSunDataSR = [];

            data.forEach(function (d) {
                d.x = d[0];
                d.y = d[1];
                d.sR = d[2];
                d.date = d[3];
            });
            data1 = [];
            var data1 = aSunDataSS;
            aSunDataSS = [];

            data1.forEach(function (d) {
                d.x = d[0];
                d.y = d[1];
                d.sS = d[2];
                d.date = d[3];
            });

            dataDL = [];
            var dataDL = aSunDataDL;
            aSunDataDL = [];

            dataDL.forEach(function (d) {
                d.x = d[0];
                d.y = d[1];
                d.dL = d[2];
                d.date = d[3];
                d.polarDay = d[4];

            });

            // Scale the range of the data - SunSet
            x.domain(d3.extent(data1, function (d) { return (d.x); }));
            y.domain([0, 24]);

            // Add the valueline path.
            svg.append("path")
                .attr("class", "line")
                .attr("d", valueline(data));

            // Add the scatterplot
            svg.selectAll("dot")
                .data(data)
                .enter().append("circle")
                .attr("r", 4).attr("fill", "blue")
                .attr("cx", function (d) { return x(d.x); })
                .attr("cy", function (d) { return y(d.y); })
                .on("mouseover", function (d) {
                    div.transition()
                        .duration(200)
                        .style("opacity", .9);
                    div.html("Sun rise " + d.sR + "<br/>" + d.date)
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                    div.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Add the scatterplot  - SS
            // Add the valueline path.
            svg.append("path")
                .attr("class", "line")
                .attr("d", valueline(data1));

            svg.selectAll("dot")
                .data(data1)
                .enter().append("circle")
                .attr("r", 4).attr("fill", "red")
                .attr("cx", function (d) { return x(d.x); })
                .attr("cy", function (d) { return y(d.y); })
                .on("mouseover", function (d) {
                    div.transition()
                        .duration(200)
                        .style("opacity", .9);
                    div.html("Sun set " + d.sS + "<br/>" + d.date)
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                    div.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Add the scatterplot  - DL
            // Add the valueline path.
            svg.append("path")
                .attr("class", "line")
                .attr("d", valueline(dataDL));

            svg.selectAll("dot")
                .data(dataDL)
                .enter().append("circle")
                .attr("r", 4).
                //                attr("fill", "yellow")
                attr("fill", function (d) {
                    if (d.y > 11.98 && d.y < 12.05) {
                        return "red";
                    } else {
                        return "orange";
                    }
                    return "yellow";
                })
                .attr("cx", function (d) { return x(d.x); })
                .attr("cy", function (d) {
                    if (d.polarDay == 0) { return y(d.y); }
                    else if (d.polarDay == 1) { return y(24); }
                    else if (d.polarDay == -1) { return y(0); }
                }
                )
                .on("mouseover", function (d) {
                    if (d.polarDay == 0) {
                        div.transition()
                            .duration(200)
                            .style("opacity", .9);
                        div.html("Day length " + d.dL + "<br/>" + d.date)
                            .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");;
                    }
                    else if (d.polarDay == 1) {
                        div.transition()
                            .duration(200)
                            .style("opacity", .9);
                        div.html("Polar day " + "<br/>" + d.date)
                            .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");;
                    }
                    else if (d.polarDay == -1) {
                        div.transition()
                            .duration(200)
                            .style("opacity", .9);
                        div.html("Polar night " + "<br/>" + d.date)
                            .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");;
                    }
                })
                .on("mouseout", function (d) {
                    div.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Add the X Axis
            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis);

            // Add the Y Axis
            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis);
        };

        function produceArrayWithDelta(Array) {  // 5 positions  - create at 6 position delta of day length
            Array.forEach(createDelta);

            function createDelta(value, index, array) {
                var lDelta;
                if (index > 0) {
                    lDelta = Math.abs(array[index][5]) - Math.abs(array[index - 1][5]);

                    if (lDelta > 0) {
                        array[index][6] = 1;
                    } else {
                        array[index][6] = -1;
                    }

                    array[index][1] = lDelta;
                    if (multip * lDelta < -7.5) {
                        //debugger;
                    }
                }
                else {
                    lDelta = 0;
                    array[index][1] = lDelta;
                };
            };
        };

        function orderArrayWithDelta(Array) {  // 5 positions  - create at 6 position delta of day length
            Array.forEach(serRightPlaceDelta);

            function serRightPlaceDelta(value, index, array) {
                if (index > 0) {
                    array[index][1] = Math.abs(1 * array[index][1]);


                };
            };
        };

        function setMaxInArrayWithDelta(Array) {  // 5 positions  - create at 6 position delta of day length
            Array.forEach(createDelta);

            function createDelta(value, index, array) {
                var lDelta;
                if ((index > 0) && (foundMax == 0)) {
                    if ((Math.abs(array[index][1]) >= Math.abs(array[index - 1][1])) &&
                        (Math.abs(array[index][1]) > Math.abs(array[index + 2][1]))) {
                        array[index][6] = maxSign;
                        foundMax = 1;
                    }
                }


            };
        };

        Number.prototype.pad = function (size) {
            var s = String(this);
            while (s.length < (size || 2)) { s = "0" + s; }
            return s;
        };

        function conv2StringWithSeconds(ivValue0) {
            //      Math.round(d.deltaSign) * (( d.y / multip ) * 60).toFixed(2)
            let lSign = "+";
            if (ivValue0 < 0) { lSign = "-" };
            let ivValue = Math.abs(ivValue0);
            let minutes = Math.floor(ivValue);
            let seconds = Math.floor((ivValue - minutes) * 60);
            return lSign + minutes + ":" + (seconds).pad(2);
        };




        function drawDataSetWDelta(oDate1, daysSpan, context, locationIndex, iPlongitude, iPlatitude, iPtimeZone, bySelection) {
            var i;
            var sunData = { x: 0, y: 0, sEvent: 0, date: "", polarDay: 0 };
            let oYear = oDate1.getFullYear();
            let oMonth = oDate1.getMonth();
            oMonth = oMonth + 1;
            let oDay = oDate1.getDate();
            let oDate2 = oDate1;
            let dayLenPrev = 0;  // delta
            let iPrev = 0;

            for (i = 0; i < daysSpan; i++) {

                oDate2.setDate(oDate1.getDate() + 1);

                oYear = oDate2.getFullYear();
                oMonth = oDate2.getMonth();
                oMonth = oMonth + 1;
                oDay = oDate2.getDate();

                if (!bySelection) {
                    oLocation1 = new Location("coord", oYear, oMonth, oDay, iPlatitude, iPlongitude, 0, 0, iPtimeZone, 0);
                }
                else {
                    // if ( i == 28) {
                    //            debugger;
                    // }
                    oLocation1 = new Location(context.locationsJSON[locationIndex].city, oYear, oMonth, oDay, context.locationsJSON[locationIndex].latitude,
                        context.locationsJSON[locationIndex].longitude, 0, 0, context.locationsJSON[locationIndex].timeZone, 0);
                }
                sunRiseRaw = oLocation1.get_sunRise_raw();
                sunSetRaw = oLocation1.get_sunSet_raw();
                sunRise = oLocation1.get_sunRise();
                sunSet = oLocation1.get_sunSet();
                dayLen = oLocation1.getDayLen();
                dayLenRaw = oLocation1.getDayLenRaw();
                dayLenDecimal = dayLen[0] + "." + dayLen[1];
                polarDay = oLocation1.getPolarDay();


                sunData.x = i * 10;
                sunData.y = sunRiseRaw;
                sunData.sEvent = sunRise;
                sunData.date = oDay.toString() + "-" + oMonth.toString() + "-" + oYear.toString();
                aSunDataSR.push([sunData.x, sunData.y, sunData.sEvent, sunData.date]);

                sunData.x = i * 10;
                sunData.y = sunSetRaw;
                sunData.sEvent = sunSet;
                aSunDataSS.push([sunData.x, sunData.y, sunData.sEvent, sunData.date]);

                sunData.x = i * 10;
                sunData.y = dayLen[0] + dayLen[1] / 60;
                sunData.sEvent = dayLen[0].toString() + ":" + dayLen[1].toString();
                sunData.polarDay = polarDay;

                aSunDataDLDelta.push([sunData.x, sunData.y, sunData.sEvent, sunData.date, sunData.polarDay, dayLenRaw, 0]);
                // last
                maxdate = oDate2;
            }
            debugger;
            produceArrayWithDelta(aSunDataDLDelta);
            setMaxInArrayWithDelta(aSunDataDLDelta);

            // D3
            d3.select("svg").remove();

            var margin = { top: 30, right: 15, bottom: 30, left: 20 },
                //width = 1500 - margin.left - margin.right,
                width = gcScreenWidth - margin.left - margin.right,
                //heightX = 400;
                heightX = document.getElementById("dSpanX").value;
            height = heightX - margin.top - margin.bottom,
                padding = 0;

            // Set the ranges
            var x = d3.time.scale().range([0, width]);
            var y = d3.scale.linear().range([height, 0]);
            var mindateNew = new Date(document.getElementById("inputDate").value);

            var xScale = d3.time.scale()
                .domain([mindateNew, maxdate])
                .range([padding, width - padding * 2]);   // map these the the chart width = total width minus padding at both sides

            //  Define the axes
            var xAxis = d3.svg.axis().scale(xScale)
                .orient("bottom").ticks(15);

            var yAxis = d3.svg.axis().scale(y)
                .orient("left").ticks(5);

            // Define the line
            var valueline = d3.svg.line()
                .x(function (d) { return x(d.x); })
                .y(function (d) { return y(d.y); });

            // Define the div for the tooltip
            var div = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            // Adds the svg canvas
            var svg = d3.select("body")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            // Get the data
            dataSR = [];
            var dataSR = aSunDataSR;
            aSunDataSR = [];

            dataSR.forEach(function (d) {
                d.x = d[0];
                d.y = d[1];
                d.sR = d[2];
                d.date = d[3];
            });
            dataSS = [];
            var dataSS = aSunDataSS;
            aSunDataSS = [];

            dataSS.forEach(function (d) {
                d.x = d[0];
                d.y = d[1];
                d.sS = d[2];
                d.date = d[3];
            });

            dataDL = [];
            var dataDLDelta = aSunDataDLDelta;
            aSunDataDLDelta = [];
            //           aSunDataDL = [];

            dataDLDelta.forEach(function (d) {
                d.x = d[0];
                d.y = d[1];
                d.dL = d[2];
                d.date = d[3];
                d.polarDay = d[4];
                d.deltaSign = d[6];
            });
            // Scale the range of the data - SunSet
            x.domain(d3.extent(dataSS, function (d) { return (d.x); }));
            y.domain([0, 24]);

            // Add the valueline path.
            svg.append("path")
                .attr("class", "line")
                .attr("d", valueline(dataSR));

            // Add the scatterplot
            svg.selectAll("dot")
                .data(dataSR)
                .enter().append("circle")
                .attr("r", 4).attr("fill", "blue")
                .attr("cx", function (d) { return x(d.x); })
                .attr("cy", function (d) { return y(d.y); })
                .on("mouseover", function (d) {
                    div.transition()
                        .duration(200)
                        .style("opacity", .9);
                    div.html("Sun rise " + d.sR + "<br/>" + d.date)
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                    div.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Add the scatterplot  - SS
            // Add the valueline path.
            svg.append("path")
                .attr("class", "line")
                .attr("d", valueline(dataSS));

            // 
            svg.selectAll("dot")
                .data(dataSS)
                .enter().append("circle")
                .attr("r", 4).attr("fill", "red")
                .attr("cx", function (d) { return x(d.x); })
                .attr("cy", function (d) { return y(d.y); })
                .on("mouseover", function (d) {
                    div.transition()
                        .duration(200)
                        .style("opacity", .9);
                    div.html("Sun set " + d.sS + "<br/>" + d.date)
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                    div.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Add the scatterplot  - DL
            // Add the valueline path.
            svg.append("path")
                .attr("class", "line")
                .attr("d", valueline(dataDLDelta));

            svg.selectAll("dot")
                .data(dataDLDelta)
                .enter().append("circle")
                .attr("r", 4).
                //                attr("fill", "yellow")
                attr("fill", function (d) {
                    d.y = multip * d.y;
                    if (d.y < 0) {
                        d.y = -1 * d.y;
                        return "red";

                    } else if (d.deltaSign == maxSign) {
                        return "blue";
                    }
                    else {


                        return "green";
                    }

                    return "yellow";
                })
                .attr("cx", function (d) { return x(d.x); })
                .attr("cy", function (d) {
                    if (d.polarDay == 0) { return y(d.y); }
                    else if (d.polarDay == 1) { return y(24); }
                    else if (d.polarDay == -1) { return y(0); }
                }
                )
                .on("mouseover", function (d) {
                    if (d.polarDay == 0) {
                        div.transition()
                            .duration(200)
                            .style("opacity", .9);
                        div.html("Delta minutes " + conv2StringWithSeconds(Math.round(d.deltaSign) * ((d.y / multip) * 60).toFixed(2)) + "<br/>" + d.date)
                            .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");;
                    }
                    else if (d.polarDay == 1) {
                        div.transition()
                            .duration(200)
                            .style("opacity", .9);
                        div.html("Polar day " + "<br/>" + d.date)
                            .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");;
                    }
                    else if (d.polarDay == -1) {
                        div.transition()
                            .duration(200)
                            .style("opacity", .9);
                        div.html("Polar night " + "<br/>" + d.date)
                            .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");;
                    }
                })
                .on("mouseout", function (d) {
                    div.transition()
                        .duration(500)
                        .style("opacity", 0);
                });


            // Add the X Axis
            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis);

            // Add the Y Axis
            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis);
        };
    </script>

</body>

</html>