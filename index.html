<!DOCTYPE html>
<html>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="https://d3js.org/d3-scale.v2.min.js"></script>
<script src="suntime.lib.js"></script>

<script type="text/javascript" src="locations.json"></script>

<meta charset="utf-8">
<style>
    /* set the CSS */

    body {
        font: 12px Arial;
    }

    path {
        stroke: steelblue;
        stroke-width: 2;
        fill: none;
    }

    .axis path,
    .axis line {
        fill: none;
        stroke: grey;
        stroke-width: 1;
        shape-rendering: crispEdges;
    }

    div.tooltip {
        position: absolute;
        text-align: center;
        width: 60px;
        height: 28px;
        padding: 2px;
        font: 12px sans-serif;
        background: lightsteelblue;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
    }

    .slider-wrapper input {
        width: 350px;
        height: 20px;
        margin: 0;

    }
</style>

<body>
    <!-- V1.0 -->
    <p><b>Sunrise/set times</b></p>

    <p><input id="inputDate" type="date" required>

        <select id="myselect">
            <option value="volvo">Volvo</option>
        </select>
        <button onclick="getSunData(this)">OK</button> </p>
    <!-- <input id="dSpan" type="number" value="200" text="Days span" size=5> -->
    <span>Days ahead: </span><span id="sliderValue"></span>
    <span class="slider-wrapper">
        <input id="dSpan" type="range" min="1" max="1370" step="1" value=200 onchange="getSunData(this)">
    </span>


    <p style="font-size: 12pt">Suntime</p>
    <span style="font-size: 12pt">Sunrise: </span><span id="sunrise"
        style="color:blue;font-weight:bold; font-size: 12pt"> </span>
    <span style="font-size: 12pt">Sunset: </span><span id="sunset" style="color:red;font-weight:bold; font-size: 12pt">
    </span>
    <span style="font-size: 12pt">Day length: </span><span id="dayLen"
        style="color:green;font-weight:bold; font-size: 12pt"> </span>
    <span id="polarDay" style="color:green;font-weight:bold; font-size: 12pt"> </span>


    <script>

        var slider = document.getElementById("dSpan");
        var output = document.getElementById("sliderValue");
        output.innerHTML = slider.value;

        slider.oninput = function () {
            output.innerHTML = this.value;
        }
        var aSunDataSR = [];
        var aSunDataSS = [];
        var aSunDataDL = [];  // DayLength

        // define the x scale (horizontal)
        let mindate = new Date(2019, 2, 4),
            maxdate = new Date(2019, 2, 30);


        function setDateMIK() {
            var mikDate = new Date();

            var mikMM = 0;
            if (
                mikDate.getMonth() < 8
            ) {
                mikMM = mikDate.getMonth() + 1;
                mikMM = "0" + mikMM;
            } else {
                mikMM = mikDate.getMonth() + 1;
            }

            var mikDD = 0;


            if (
                mikDate.getDate() < 10
            ) {

                mikDD = "0" + mikDate.getDate();
            } else {
                mikDD = mikDate.getDate() + 1;
            }

            let formatted_date = mikDate.getFullYear() + "-" + mikMM + "-" + mikDD;
            document.getElementById('inputDate').value = formatted_date;
        };
        window.onload = setDateMIK();

        let PrefixSR = " ";
        let PrefixSS = " ";
        let PrefixDD = " ";


        function getSunData(context) {


            let oDate0 = new Date(document.getElementById("inputDate").value);
            var mindate = new Date(document.getElementById("inputDate").value);

            let oYear = oDate0.getFullYear();
            let oMonth = oDate0.getMonth();
            oMonth = oMonth + 1;
            let oDay = oDate0.getDate();

            this.locationsJSON = locations;

            var selectedOption = 0;
            if (this.select != null) {
                selectedOption = this.select.selectedIndex;
            }

            let oLocation1 = new Location(this.locationsJSON[selectedOption].city, oYear, oMonth, oDay, this.locationsJSON[selectedOption].latitude,
                this.locationsJSON[selectedOption].longitude, 0, 0, this.locationsJSON[selectedOption].timeZone, 0);

            let sunRise = oLocation1.get_sunRise();
            let sunSet = oLocation1.get_sunSet();
            let dayLen = oLocation1.getDayLen();
            let polarDay = oLocation1.getPolarDay();

            document.getElementById("sunrise").innerHTML = PrefixSR + sunRise[0] + ":" + sunRise[1];
            document.getElementById("sunset").innerHTML = PrefixSS + sunSet[0] + ":" + sunSet[1];
            document.getElementById("dayLen").innerHTML = PrefixDD + dayLen[0] + ":" + dayLen[1];

            if (polarDay == 1) {
                document.getElementById("polarDay").innerHTML = "Polar Day";
            }
            else if (polarDay == -1) { document.getElementById("polarDay").innerHTML = "Polar Night" }
            else { document.getElementById("polarDay").innerHTML = " " };





            let daysSpan = document.getElementById("dSpan").value;

            var selectedOption = 0;
            if (this.select != null) {
                selectedOption = this.select.selectedIndex;
            }


            getDataSet(oDate0, daysSpan, this, selectedOption);



        };

        (function init() {
            getSunData();
        })();


        this.select = document.getElementById("myselect");

        var options = this.locationsJSON

        // Optional: Clear all existing options first:
        this.select.innerHTML = "";
        // Populate list with options:
        for (var i = 0; i < options.length; i++) {
            var opt = options[i].city;
            this.select.innerHTML += "<option value=\"" + opt + "\">" + opt + "</option>";
        };

        function getDataSet(oDate1, daysSpan, context, locationIndex) {
            var i;
            var sunData = { x: 0, y: 0, sEvent: 0, date: "" };
            let oYear = oDate1.getFullYear();
            let oMonth = oDate1.getMonth();
            oMonth = oMonth + 1;
            let oDay = oDate1.getDate();
            let oDate = oDate1;


            for (i = 0; i < daysSpan; i++) {

                //oDate.addDays(i);

                oDate.setDate(oDate1.getDate() + 1);

                oYear = oDate.getFullYear();
                oMonth = oDate.getMonth();
                oMonth = oMonth + 1;
                oDay = oDate.getDate();


                oLocation1 = new Location(context.locationsJSON[locationIndex].city, oYear, oMonth, oDay, context.locationsJSON[locationIndex].latitude,
                    context.locationsJSON[locationIndex].longitude, 0, 0, context.locationsJSON[locationIndex].timeZone, 0);
                //    oDay = oDay + 1;
                sunRiseRaw = oLocation1.get_sunRise_raw();
                sunSetRaw = oLocation1.get_sunSet_raw();
                sunRise = oLocation1.get_sunRise();
                sunSet = oLocation1.get_sunSet();
                dayLen = oLocation1.getDayLen();


                sunData.x = i * 10;
                sunData.y = sunRiseRaw;
                sunData.sEvent = sunRise;
                sunData.date = oDay.toString() + "-" + oMonth.toString() + "-" + oYear.toString();
                aSunDataSR.push([sunData.x, sunData.y, sunData.sEvent, sunData.date]);

                sunData.x = i * 10;
                sunData.y = sunSetRaw;
                sunData.sEvent = sunSet;
                aSunDataSS.push([sunData.x, sunData.y, sunData.sEvent, sunData.date]);

                sunData.x = i * 10;
                sunData.y = dayLen[0] + dayLen[1] / 60;
                sunData.sEvent = dayLen[0].toString() + ":" + dayLen[1].toString();
                aSunDataDL.push([sunData.x, sunData.y, sunData.sEvent, sunData.date]);



                // last
                maxdate = oDate;
            }



            // D3
            d3.select("svg").remove();

            var margin = { top: 30, right: 20, bottom: 30, left: 50 },
                width = 1400 - margin.left - margin.right,
                height = 470 - margin.top - margin.bottom,
                //     var width = 700,
                // height = 400,
                padding = 100;

            // Set the ranges
            var x = d3.time.scale().range([0, width]);
            var y = d3.scale.linear().range([height, 0]);

            var xScale = d3.time.scale()
                .domain([mindate, maxdate])    // values between for month of january
                .range([padding, width - padding * 2]);   // map these the the chart width = total width minus padding at both sides



            //  Define the axes
            var xAxis = d3.svg.axis().scale(xScale)
                .orient("bottom").ticks(5);

            var yAxis = d3.svg.axis().scale(y)
                .orient("left").ticks(5);


            // Define the line

            var valueline = d3.svg.line()
                .x(function (d) { return x(d.x); })
                .y(function (d) { return y(d.y); });

            // Define the div for the tooltip
            var div = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            // Adds the svg canvas


            var svg = d3.select("body")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");

            // Get the data
            data = [];
            var data = aSunDataSR;
            aSunDataSR = [];


            data.forEach(function (d) {
                d.x = d[0];
                d.y = d[1];
                d.sR = d[2];
                d.date = d[3];
            });
            data1 = [];
            var data1 = aSunDataSS;
            aSunDataSS = [];

            data1.forEach(function (d) {
                d.x = d[0];
                d.y = d[1];
                d.sS = d[2];
                d.date = d[3];
            });


            dataDL = [];
            var dataDL = aSunDataDL;
            aSunDataDL = [];

            dataDL.forEach(function (d) {
                d.x = d[0];
                d.y = d[1];
                d.dL = d[2];
                d.date = d[3];
            });
            // Scale the range of the data - SunSet
            x.domain(d3.extent(data1, function (d) { return d.x; }));
            //            x.domain([0, 1200])
            // y.domain([0, d3.max(data1, function(d) { return d.y; })]);
            y.domain([0, 24]);

            // Add the valueline path.
            svg.append("path")
                .attr("class", "line")
                .attr("d", valueline(data));

            // Add the scatterplot
            svg.selectAll("dot")
                .data(data)
                .enter().append("circle")
                .attr("r", 4).attr("fill", "blue")
                .attr("cx", function (d) { return x(d.x); })
                .attr("cy", function (d) { return y(d.y); })
                .on("mouseover", function (d) {
                    div.transition()
                        .duration(200)
                        .style("opacity", .9);
                    div.html("Sun rise " + d.sR + "<br/>" + d.date)
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                    div.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Add the scatterplot  - SS

            // Add the valueline path.
            svg.append("path")
                .attr("class", "line")
                .attr("d", valueline(data1));

            svg.selectAll("dot")
                .data(data1)
                .enter().append("circle")
                .attr("r", 4).attr("fill", "red")
                .attr("cx", function (d) { return x(d.x); })
                .attr("cy", function (d) { return y(d.y); })
                .on("mouseover", function (d) {
                    div.transition()
                        .duration(200)
                        .style("opacity", .9);
                    div.html("Sun set " + d.sS + "<br/>" + d.date)
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                    div.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Add the scatterplot  - DL

            // Add the valueline path.
            svg.append("path")
                .attr("class", "line")
                .attr("d", valueline(dataDL));

            svg.selectAll("dot")
                .data(dataDL)
                .enter().append("circle")
                .attr("r", 4).
                //                attr("fill", "yellow")
                attr("fill", function (d) {
                    if (d.y > 11.98 && d.y < 12.05) {
                        return "red";
                    } else {
                        return "orange";
                    }
                    return "yellow";
                })
                .attr("cx", function (d) { return x(d.x); })
                .attr("cy", function (d) { return y(d.y); })
                .on("mouseover", function (d) {
                    div.transition()
                        .duration(200)
                        .style("opacity", .9);
                    div.html("Day length " + d.dL + "<br/>" + d.date)
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                    div.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Add the X Axis
            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis);

            // Add the Y Axis
            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis);
        };
    </script>

</body>

</html>